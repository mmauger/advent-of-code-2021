;;; day3.el --- advent of code day3                  -*- lexical-binding: t; -*-

;; Copyright (C) 2021  Michael R. Mauger

;; Author: Michael R. Mauger <michael@mauger.com>
;; Keywords:

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or
;; (at your option) any later version.

;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.

;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see <https://www.gnu.org/licenses/>.

;;; Commentary:

;; gamma/epsilon rates

;;; Code:

(defvar day3-data '(
#b010100110111
#b101001010000
#b101011110010
#b100100011101
#b101000011000
#b110011011110
#b111010010100
#b001111100000
#b111101100001
#b100010101110
#b101101110101
#b010010101110
#b111001110100
#b000101111000
#b111101111100
#b000010001100
#b101010111101
#b001010011011
#b001101101101
#b000000110100
#b001100101011
#b110110110010
#b001110000011
#b011001111001
#b110100110011
#b011000110001
#b111100100010
#b101011000000
#b011101000111
#b011111000111
#b111011001110
#b011111010100
#b001110110001
#b010110110001
#b100111011011
#b100110100100
#b110010111000
#b101111001100
#b101111111001
#b000001000110
#b100010010110
#b110111100101
#b001001010101
#b001110001011
#b101111001011
#b111011110010
#b101001001100
#b101010100001
#b000000111101
#b100000000111
#b111010111101
#b000110110111
#b100100101111
#b110101100101
#b011010110010
#b110100001110
#b001011011010
#b010101010101
#b011110000100
#b010000000010
#b010111010111
#b011010011100
#b101101001011
#b000111100101
#b101111001000
#b000100010000
#b111000011111
#b100001010101
#b011101111110
#b001111011110
#b001100111111
#b000011000100
#b001011101010
#b001011010111
#b101001001110
#b010101011001
#b110101001011
#b011110011110
#b001000110010
#b011101110001
#b101110000000
#b000001100111
#b110111000011
#b001001111010
#b100100000000
#b000000011101
#b111110111011
#b101001111100
#b110110100010
#b101011011000
#b000111100010
#b011000110100
#b111100100100
#b010010100000
#b111101001011
#b111001000000
#b001001000001
#b010010100001
#b110110001100
#b001101100001
#b011110010110
#b100111011101
#b001001110110
#b001001100011
#b011001111010
#b110110010111
#b110100111010
#b111110011100
#b100000100111
#b010001101101
#b110100110101
#b101111101001
#b100110010000
#b100011001111
#b101111001010
#b001110111001
#b111101001101
#b001010111101
#b010010011010
#b100101101111
#b100000011110
#b011111010001
#b000010001101
#b010100101100
#b001010001100
#b100111011100
#b011110000000
#b100000011111
#b000010010100
#b000001001101
#b011111011111
#b100101001101
#b000100010110
#b011011111100
#b000111000011
#b010100101011
#b011000101111
#b001001100111
#b110111110100
#b111101111011
#b110011010101
#b100111111111
#b010100010000
#b001111110101
#b010011010001
#b101000111111
#b000001110100
#b010010010000
#b100010000101
#b110111100111
#b001011111101
#b101100101101
#b001010110100
#b000100110001
#b111101110110
#b111110101110
#b100011100110
#b011001001010
#b001000010111
#b010001110110
#b011110000010
#b101010101111
#b110100100100
#b010001100101
#b001011111110
#b100111100000
#b111101000010
#b101101011110
#b101100111100
#b001110011100
#b110110100101
#b000110111010
#b011001010111
#b010001000011
#b100010010111
#b000110110000
#b001000010101
#b010011010010
#b110000100010
#b010000101110
#b010110111000
#b011101001000
#b011110000111
#b100110100011
#b110011001001
#b001110000111
#b000001101110
#b001000100110
#b011101111000
#b101100000101
#b110001100000
#b101000100101
#b110101110101
#b111000101111
#b101000101001
#b101000100000
#b101011010110
#b000010111100
#b011101101000
#b000110101001
#b000110110110
#b100111001011
#b100010001101
#b101111000111
#b100100111000
#b100100111100
#b000000100010
#b100110000111
#b101110001100
#b110010010010
#b100110010011
#b100100000011
#b000001011111
#b110100100000
#b000000111100
#b110110010001
#b001101111110
#b010011010011
#b001000111110
#b100010010100
#b000111110101
#b111111101001
#b100110001110
#b101011011101
#b110100100010
#b010100001000
#b100111101001
#b010111010001
#b001110101000
#b100111101111
#b100010101011
#b101111100111
#b111001100110
#b111100110101
#b001101001111
#b111011011111
#b011011100110
#b101111011000
#b100110110001
#b100010011101
#b000111010101
#b101101011100
#b111010100100
#b001101000100
#b101111100101
#b010110001010
#b111101010000
#b100111110100
#b100000000011
#b010001111110
#b011010001110
#b110100010100
#b010100111100
#b011001101100
#b110101001001
#b000011100111
#b011000000000
#b110001000011
#b101011001101
#b001010110000
#b010000011010
#b101110101010
#b001010011111
#b011101000101
#b110011101010
#b101110001110
#b100111110000
#b100100010100
#b010011101000
#b100110000110
#b111100010011
#b011101101011
#b100110010100
#b011011100001
#b011111100110
#b111100101111
#b000111101001
#b100101011101
#b010101001110
#b110011110011
#b111011011100
#b101001101111
#b100001010111
#b110010111001
#b011011101011
#b111110001010
#b000010111110
#b011010000101
#b011011000111
#b110000000101
#b010110111011
#b010110110000
#b011000110110
#b100101001000
#b000111110001
#b011110000101
#b001000010000
#b011011000011
#b100101100011
#b010000100000
#b100010011000
#b001011100001
#b000110100010
#b011000111010
#b100011001011
#b101111111010
#b001100110101
#b101100111111
#b010011100111
#b001110110010
#b000100100110
#b010100010001
#b100100011011
#b110110100100
#b100011011001
#b110001000110
#b110110100000
#b101110001010
#b000100101010
#b000000100110
#b110110111110
#b011000111101
#b001101111000
#b110001100001
#b101011011100
#b101100001000
#b100000111011
#b011110010100
#b010000101111
#b100011100101
#b100111010100
#b000011010110
#b111010110011
#b010101000001
#b001101010100
#b010001010011
#b100011000101
#b011100011111
#b100101100010
#b011111011100
#b011010010000
#b011011011110
#b101000000100
#b110111111100
#b100111110011
#b110100010010
#b100100011111
#b000100001101
#b001101100010
#b000001010110
#b110110010010
#b001110000110
#b101100110101
#b111000110011
#b111110111111
#b001000111000
#b010101111010
#b010011101010
#b010010100100
#b000101001011
#b010011011010
#b100110111011
#b100011110111
#b111001001011
#b011000000111
#b000101101101
#b001000011100
#b110111111010
#b011010101001
#b110000010101
#b011001110010
#b001001001011
#b111010110110
#b101010000110
#b110111010011
#b101110011010
#b011111110101
#b010100110011
#b010000100111
#b010100001011
#b011111010110
#b110011111110
#b100100111101
#b000100111001
#b011011101111
#b111010001101
#b100000110101
#b110000000010
#b111110101011
#b011000010110
#b001011101100
#b010001110011
#b111010111010
#b100010011110
#b001100000011
#b000101110000
#b111011101111
#b111000000111
#b100101011100
#b010111000010
#b010010111010
#b001111111100
#b101001000000
#b000010111111
#b001110011000
#b111110011110
#b101101000110
#b101110100110
#b100011011100
#b101100000001
#b111001111011
#b101010101000
#b010111101110
#b000010100101
#b100010111000
#b101111000100
#b000010011101
#b011000111011
#b010110011011
#b010101100010
#b100101010111
#b011010101110
#b110011011011
#b110100101011
#b110110111100
#b000101110011
#b011001110101
#b111000100100
#b101010000001
#b110111100011
#b100001000110
#b001101011111
#b101010000101
#b011111111000
#b000111011110
#b100001111101
#b011010010010
#b101010011100
#b101110101100
#b000001010100
#b101010100110
#b001100101010
#b101110100100
#b100100111001
#b110010100111
#b000100001110
#b111001110101
#b110000101110
#b000010011000
#b010001110010
#b000100010011
#b011110100001
#b001010111010
#b010010111001
#b010001001011
#b101101001110
#b011001000110
#b110110011001
#b110111000000
#b011010111001
#b001000010001
#b010110011100
#b000111110010
#b101110000010
#b000101001100
#b110010111101
#b001101010000
#b010010011001
#b010000010111
#b011110011100
#b111000100011
#b110101011000
#b101100100010
#b111111100110
#b010011111110
#b111110000100
#b100010100100
#b101110111100
#b110000010010
#b011010000110
#b000101100101
#b001011001000
#b111000110001
#b000010001011
#b111000010000
#b100000101000
#b001101011101
#b101000101100
#b010100111010
#b101100000110
#b001111010011
#b011111110011
#b101000100010
#b111000001111
#b111000111010
#b001110000101
#b110001010011
#b011101011010
#b101001000101
#b111111001110
#b111110110101
#b110001110100
#b101101010101
#b000100011111
#b101100100110
#b000111011000
#b101010110001
#b000100110110
#b101101110111
#b100011101000
#b010011110101
#b110101111001
#b110001110011
#b000100111100
#b010011010110
#b101100000100
#b011011101000
#b101110000100
#b100100010110
#b111011100100
#b011010110000
#b100111011010
#b110100011010
#b101111111111
#b110110011100
#b110011100101
#b100001111100
#b111101100110
#b110010001010
#b010001001101
#b101110100001
#b111101001100
#b110101000100
#b011001110000
#b010110100011
#b111111000001
#b110010100000
#b101100110000
#b110000000000
#b001101110111
#b001100001000
#b001101101000
#b101100100011
#b001001011011
#b011011101110
#b010011111000
#b110100111000
#b011001101010
#b111011111010
#b100011111010
#b001011011110
#b111101100101
#b100011100100
#b101110101000
#b000111110110
#b100111010001
#b110000011100
#b111111111110
#b110100010101
#b101001110011
#b000010001110
#b000010001001
#b110000110000
#b001001000110
#b110111110000
#b010101010010
#b111101110001
#b110101101101
#b010111000111
#b111010110111
#b001011011011
#b001001100001
#b101000101110
#b101100110010
#b100100100100
#b011110111001
#b011100000110
#b100110110111
#b111010001110
#b110111111011
#b011010111000
#b011101100001
#b011110001111
#b110101011011
#b000000001111
#b101000001110
#b111010101110
#b001100001110
#b010111000101
#b111100111110
#b001110101110
#b011101111010
#b011100001111
#b000000000101
#b111111000100
#b000110010101
#b001101000010
#b111001111100
#b101100010100
#b001011001001
#b010110000010
#b010001101000
#b001111101111
#b011011011011
#b111110000001
#b100111011000
#b011000000110
#b100111101110
#b101100000000
#b101011000100
#b111000011101
#b100001101001
#b100001101000
#b011110001001
#b110110011011
#b011100010111
#b000100111000
#b000110000001
#b000111001100
#b000111111010
#b110110000001
#b000010011010
#b100000101001
#b101110001011
#b100010110101
#b110011010000
#b111101111111
#b100101011110
#b101110011111
#b111111011111
#b011010010110
#b010100101010
#b001010100001
#b000000110110
#b110000111101
#b010101101011
#b110100100001
#b011110001110
#b111001010011
#b001000001000
#b000011111110
#b111000100110
#b100100101000
#b011011000110
#b111001100011
#b111100101000
#b110001100010
#b011000000001
#b111101010010
#b001011000100
#b010100110110
#b000001111101
#b001010000011
#b010010100110
#b100000011101
#b101011010011
#b000111110000
#b101001001011
#b100000001000
#b010000111100
#b000100101011
#b011101010000
#b101101010010
#b100010011001
#b001101100101
#b101010010100
#b111011111001
#b101000010001
#b001111000000
#b011001000010
#b100101010110
#b000100001100
#b010000101000
#b110001111111
#b000101010111
#b110100101110
#b111100110001
#b101011000001
#b101100101110
#b110000101100
#b101100111110
#b111000010110
#b010110101110
#b001010100110
#b110011010010
#b111001100000
#b100100100001
#b000011011001
#b111011011110
#b011110000011
#b101000100001
#b101010010001
#b101001100001
#b100011001010
#b100000000110
#b010000100001
#b001011011001
#b110111010100
#b111001000111
#b111111110010
#b101010100101
#b100110001011
#b010110011001
#b110001111110
#b100100000111
#b110001110111
#b101110010101
#b010010111000
#b000000011001
#b101110000011
#b100001010000
#b001100001011
#b111111001100
#b111010010010
#b010011100001
#b100001111000
#b000010000110
#b010100011100
#b101111101010
#b100110010101
#b101001101001
#b100110101001
#b001001011100
#b001100011101
#b001100011001
#b000100100100
#b100011010100
#b000100001011
#b111101100011
#b011010001011
#b111000101101
#b101000010000
#b010110001111
#b111100010110
#b000111111101
#b100100111011
#b101011000010
#b011001100010
#b101111011100
#b101001110101
#b101111101100
#b110101001111
#b111101100000
#b101110011011
#b100101110000
#b001100111110
#b010010101010
#b001100100100
#b001010101100
#b001101100111
#b110010011100
#b010000001001
#b011011110001
#b100101110001
#b101111100100
#b110101101000
#b110000100000
#b101010011101
#b111000010011
#b100001010100
#b000101101010
#b101111001001
#b000110101101
#b101011010111
#b000001001100
#b100100111110
#b000010111011
#b000100000100
#b100100001110
#b011010000001
#b010101110011
#b111101101101
#b101110101111
#b100010100011
#b110001011101
#b110001011011
#b100011110011
#b111000011011
#b110101110010
#b000110010100
#b101000001010
#b011001011010
#b111000001101
#b101001101101
#b111001000001
#b000100000110
#b110000000110
#b010011001110
#b011101000001
#b010000101101
#b010011011001
#b010101001111
#b011110110001
#b100111110001
#b101111011101
#b111001000010
#b111111111000
#b001011101011
#b001010100111
#b111110111101
#b011111011101
#b000100111101
#b010010000101
#b001111101011
#b110010100100
#b110001011001
#b010111111000
#b100100101110
#b110111011101
#b100100000110
#b111111011011
#b101101111001
#b111011010001
#b000000011100
#b011011101001
#b100010111101
#b110111000110
#b001100110010
#b111100111100
#b111111000010
#b100111010111
#b100011001100
#b110101011100
#b001111001100
#b101010000010
#b110011010111
#b110011010001
#b001110110110
#b000011011100
#b001011001011
#b100000000001
#b110000100011
#b011011110011
#b100101100100
#b011100100011
#b100001110111
#b011101001001
#b011101100011
#b011001001101
#b011001000100
#b010111001111
#b100001001111
#b101001100000
#b110010001011
#b010101011100
#b011110110010
#b111010000110
#b000010100100
#b110111000111
#b001011010110
#b010001000100
#b110100010111
#b010101100110
#b010011101111
#b101000001000
#b011011001011
#b100001000001
#b101111110011
#b100110110011
#b100011100000
#b101101000010
#b000101011000
#b111101110010
#b110111010110
#b101110000110
#b110010110001
#b000001101111
#b110101101111
#b000010111010
#b100010010001
#b111010011001
#b011110011011
#b000110101010
#b010100001111
#b010111011000
#b000011110100
#b010001010101
#b110111011001
#b010001111001
#b111010111111
#b010010010001
#b010001100011
#b111110001001
#b101000010111
#b001101110101
#b111011000000
#b001100110100
#b000110001001
#b110111101001
#b010100110000
#b101110111110
#b100000000010
#b110011010011
#b010101100101
#b110100110001
#b100010100010
#b101111111000
#b111111100100
#b011100001101
#b000000100001
#b100110100110
#b010100100011
#b000000001000
#b101010110100
#b100010001111
#b111000001011
#b010101000111
#b001111110001
#b000000111011
#b111111101100
#b001110110000
#b011110111011
#b001110100011
#b100110000010
#b010110110011
#b001001101110
#b110011101110
#b111001100010
#b111100010000
#b000001010111
#b001110001100
#b110000101000
#b100101111010
#b001011001110
#b100111101100
#b111001101100
#b110111110010
#b101000110100
#b100011100011
#b100000100101
#b100001111011
#b011110101001
#b000111000100
#b010111100001
#b111111010001
#b100100001100
#b111111010111
#b001101111101
#b000110001101
#b010110000001
#b111011010110
#b011110110110
#b011111001001
#b001101011010
#b010101110101
#b110001100100
#b101101011101
#b011011010110
#b001011001101
#b101110110101
#b001101010010
#b101010001101
#b100111000000
#b110110101100
#b001011111000
#b000100111011
#b000111110111
#b101000111100
#b110000110011
#b000001000011
#b000111111110
#b001010010010
#b100000111001
#b010101111100
#b001100010100
#b010101110111
#b110101010010
#b000001001111
#b101101111100
#b011110111101
#b111001010001
#b000100101101
#b011100100100
#b110101000111
#b011111100011
#b110001001101
#b100001100111
#b101101100111
#b000100110000
#b101001100010
#b001101101111
#b100011000100
#b011100101111
#b011001100100
#b011010011110
#b010011001010
#b011110101000
#b111101111010
#b110001010100
#b000110010001
#b001111011011
#b110000111011
#b000001111001
#b010011001100
#b100110101011
#b111011001011
#b001100110011
#b010010011101
#b100011110000
#b110011110111
))

(defvar day3-test '(
#b00100
#b11110
#b10110
#b10111
#b10101
#b01111
#b00111
#b11100
#b10000
#b11001
#b00010
#b01010
))

(defun day3a-diagnostic (diag)
  "Day 3a of DIAG."
  (let* ((m (length diag))
         (n (1+ (logb (apply #'max diag))))
         (1bit (make-vector n 0))
         (gamma 0)
         (epsilon 0)
         mask
         (place 1))
    (mapc
     (lambda (d)
       (setq mask 1)
       (dotimes (b n)
         (cl-incf (aref 1bit b)
                  (if (zerop (logand d mask)) 0 place))
         ;; (message ">> %S %S: %S" b (logand d mask) 1bit)
         (cl-incf mask mask))
       (cl-incf place place))
     diag)
    ;; (message ">> %S" 1bit)
    (setq mask 1)
    (dotimes (b n)
      ;; (message ">> %S: %S %S" b m (* 2 (logcount (aref 1bit b))))
      (if (> m (* 2 (logcount (aref 1bit b))))
          (cl-incf epsilon mask)
        (cl-incf gamma mask))
      (cl-incf mask mask))
  (list gamma epsilon (* gamma epsilon))))

(day3a-diagnostic day3-test)
;; => (22 9 198)
(day3a-diagnostic day3-data)
;; => (2484 1611 4001724)

(defun day3-bits (d n)
  "Return list in N bits in D."
  (let (bitl)
    (dotimes (b n)
      (push (logand d 1) bitl)
      (setq d (lsh d -1)))
    bitl))

(day3-bits 30 5)

(defun day3b-diag-bit (diag lead)
  "Return number of 1 bits in DIAG entries starting with LEAD."
  (let* ((n (1+ (logb (apply #'max diag))))
         (ll (length lead))
         (ll- (- n ll))
         (cnt 0)
         (res 0))
    (mapc
     (lambda (d)
       (let ((bitl (day3-bits d n)))
         (when (equal (butlast bitl ll-) lead)
           (message "%S %S %S: %S" lead bitl ll (nth ll bitl))
           (cl-incf cnt)
           (cl-incf res (nth ll bitl)))))
     diag)
    (message "%S %S" res (- cnt res))
    (list res (- cnt res))))

(day3b-diag-bit day3-test '())
(day3b-diag-bit day3-test '(0 1 0))

(defmacro day3-measure (diag lead n mostp)
  `(setq ,lead (append ,lead
                       (list
                        (let* ((bits (day3b-diag-bit ,diag ,lead)))
                          (cond
                           ((equal bits '(1 0)) 1)
                           ((equal bits '(0 1)) 0)
                           ((apply #'>= bits) ,(if mostp 1 0))
                           (t ,(if mostp 0 1))))))))

(defun mapagg (func seq init)
  (let ((agg init))
    (mapc
     (lambda (x)
       (setq agg (funcall func agg x)))
     seq)
    agg))

(defun *2+ (n i)
  (+ (* 2 n) i))

(defun day3b-diagnostic (diag)
  "Day 3a of DIAG."
  (let* ((m (length diag))
         (n (1+ (logb (apply #'max diag))))
         (o2 0) o2-lead
         (co2 0) co2-lead)
    (dotimes (_b n)
      (message ">> %S %S %S" _b o2-lead co2-lead)
      (day3-measure diag o2-lead m t)
      (day3-measure diag co2-lead m nil))
    (message "%S %S" o2-lead co2-lead)
    (setq o2 (cl-reduce #'*2+ o2-lead :initial-value 0))
    (setq co2 (cl-reduce #'*2+ co2-lead :initial-value 0))
    (list o2 co2 (* o2 co2))))

(day3b-diagnostic day3-test)
;; => (23 10 230)
(day3b-diagnostic day3-data)
;; => (2545 231 587895)
(provide 'day3)
;;; day3.el ends here
